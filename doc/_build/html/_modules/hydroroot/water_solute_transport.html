<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hydroroot.water_solute_transport &mdash; HydroRoot 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> HydroRoot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick-start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeling_principles.html">Modeling principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">HydroRootâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">HydroRoot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>hydroroot.water_solute_transport</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hydroroot.water_solute_transport</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="c1">#, sparse</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csc_matrix</span><span class="p">,</span> <span class="n">linalg</span>
<span class="kn">from</span> <span class="nn">openalea.mtg</span> <span class="kn">import</span> <span class="n">traversal</span>

<div class="viewcode-block" id="pressure_calculation"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.pressure_calculation">[docs]</a><span class="k">def</span> <span class="nf">pressure_calculation</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mi">298</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="n">Ce</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Cse</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">Pe</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">Pbase</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">C_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;the system of equation under matrix form is solved using a Newton-Raphson schemes, at each step a system A dx = b</span>
<span class="sd">    is solved by LU decomposition.</span>

<span class="sd">    :param g: MTG</span>
<span class="sd">    :param Temp: float (Default value = 298)</span>
<span class="sd">    :param sigma: float (Default value = 1.0)</span>
<span class="sd">    :param Ce: float (Default value = 0.0)</span>
<span class="sd">    :param Cse: float (Default value = 0.0)</span>
<span class="sd">    :param dP: float (Default value = None)</span>
<span class="sd">    :param Pe: float (Default value = 0.4)</span>
<span class="sd">    :param Pbase: float (Default value = 0.1)</span>
<span class="sd">    :param data: numpy array (Default value = None)</span>
<span class="sd">    :param row: numpy array (Default value = None)</span>
<span class="sd">    :param col: numpy array (Default value = None)</span>
<span class="sd">    :param C_base: float (Default value = None)</span>
<span class="sd">    :returns: - g (MTG)</span>
<span class="sd">        - dx (array)</span>
<span class="sd">        - data (array)</span>
<span class="sd">        - row (array)</span>
<span class="sd">        - col (array)</span>
<span class="sd">    </span>
<span class="sd">    This function take into account the possibility to have non-permeating solute inside the root. This is, for instance,</span>
<span class="sd">    the case when performing cut and flow experiment in a solution containing such solute. Indeed, the non-permeating solute</span>
<span class="sd">    may enter the root at cut tips. It is referred to this non-permeating solute through Cpeg when C refers to the permeating solute</span>
<span class="sd">    penetrating radially the root.</span>
<span class="sd">    The presence of Cpeg may change the sap viscosity and has influence on the osmotic pressure see beginning of</span>
<span class="sd">    the function inside the root.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_out&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">p_in</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_in&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">J_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_out&#39;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">Kexp</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K_exp&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>  <span class="c1"># en mol/microL</span>
    <span class="n">Cpeg</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;Cpeg&#39;</span><span class="p">)</span>  <span class="c1"># en mol/microL</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span>  <span class="c1"># 1 if Pin &gt;= Pout, 0 otherwise</span>
    <span class="n">J_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_s&#39;</span><span class="p">)</span>
    <span class="n">P_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;P_s&#39;</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
    <span class="n">dKdCpeg</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">sigmaRT</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">Temp</span> <span class="o">*</span> <span class="mf">1.0e3</span>  <span class="c1"># if C in mol/microL *1e9, and P in MPa *1e-6 =&gt; *1e3</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g of water</span>
        <span class="n">dmu</span> <span class="o">=</span> <span class="n">derivative_viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g of water</span>
        <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Kexp</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dmu</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pbase</span> <span class="o">+</span> <span class="n">dP</span>
    <span class="n">Pi_e_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
    <span class="n">psi_ext</span> <span class="o">=</span> <span class="n">p_ext</span> <span class="o">-</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="n">Pi_e_peg</span>  <span class="c1"># subtract the osmotic pressure</span>
    <span class="n">derivative</span> <span class="o">=</span> <span class="n">derivative_osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>

    <span class="c1"># Select the base of the root</span>
    <span class="n">v_base</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># it has to be = 1 here because based on first index == 1</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">C_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_base</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v_base</span><span class="p">]</span>  <span class="c1"># boundary condition at the root base</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">12</span>  <span class="c1"># -12 because of the coefficients outside the matrix at the boundaries</span>
    <span class="c1">############</span>
    <span class="c1"># row and col indexes should be calculated once</span>
    <span class="c1">############</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dCpeg_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGp_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">############</span>
    <span class="c1"># non-zero Jacobian terms</span>
    <span class="c1">############</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C_base</span> <span class="c1"># C[v]  # dC/dx=0 =&gt; Cp=C[1] or C[1] = C_base</span>
            <span class="c1"># theta[v] = 1.0 # F. Bauget 2022-08-03</span>
            <span class="n">Cpeg_parent</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">Cpeg_parent</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

            <span class="c1"># dGp_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
        <span class="n">var_peg</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var_peg</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var_peg</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Ce</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

        <span class="c1"># dGp_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGCpeg_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_peg</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGp_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGp_i/dCpeg_i</span>
        <span class="n">derivative</span> <span class="o">=</span> <span class="n">derivative_osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">derivative</span> <span class="o">+</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dCpeg_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGCpeg_i/dCpeg_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> \
                    <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="c1"># dGp_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">-</span> \
                        <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># -Gp</span>
        <span class="n">Pi_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_parent</span> <span class="o">+</span> <span class="n">diag</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">psi_ext</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Pi_peg</span><span class="p">)</span>
        <span class="c1"># -Gc</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span>
                         <span class="n">J_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="c1"># -GCpeg</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>  <span class="c1"># += because it is -Gp</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_ext</span>  <span class="c1"># += because it is -Gp</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Ce</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># ## to avoid singular matrix in A, especially when Js and/or Ps are zero and the Cini = 0.0</span>
    <span class="c1"># ## damping the inversion by adding a small value to the diagonal, this value is called Marquardt-Levenberg coefficient</span>
    <span class="c1"># for i in np.where((A.diagonal()) == 0)[0]:</span>
    <span class="c1">#     A[i,i] = 1.0e-10</span>

    <span class="n">solve</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">solve</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Ce</span><span class="p">:</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ce</span>
        <span class="k">if</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-20</span>
        <span class="k">if</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pbase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Pi_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
        <span class="n">J_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pi_peg</span><span class="p">)</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="c1"># J_s[v] = tau # F. Bauget 2022-09-27</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>


<div class="viewcode-block" id="pressure_calculation_no_non_permeating_solutes"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.pressure_calculation_no_non_permeating_solutes">[docs]</a><span class="k">def</span> <span class="nf">pressure_calculation_no_non_permeating_solutes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mi">298</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">Ce</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                                                   <span class="n">Cse</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="n">Pe</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">Pbase</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">C_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;As :func:`~water_solute_transport.py.pressure_calculation` without non-permeating solutes</span>

<span class="sd">    :param g: MTG</span>
<span class="sd">    :param Temp: float (Default value = 298)</span>
<span class="sd">    :param sigma: float (Default value = 1.0)</span>
<span class="sd">    :param Cse: float (Default value = 0.0)</span>
<span class="sd">    :param dP: float (Default value = None)</span>
<span class="sd">    :param Pe: float (Default value = 0.4)</span>
<span class="sd">    :param Pbase: float (Default value = 0.1)</span>
<span class="sd">    :param data: numpy array (Default value = None)</span>
<span class="sd">    :param row: numpy array (Default value = None)</span>
<span class="sd">    :param col: numpy array (Default value = None)</span>
<span class="sd">    :param C_base: float (Default value = None)</span>
<span class="sd">    :param Ce:  (Default value = 0.0)</span>
<span class="sd">    :returns: - g (MTG)</span>
<span class="sd">        - dx (array)</span>
<span class="sd">        - data (array)</span>
<span class="sd">        - row (array)</span>
<span class="sd">        - col (array)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_out&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">p_in</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_in&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">J_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_out&#39;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>  <span class="c1"># en mol/microL</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span>  <span class="c1"># 1 if Pin &gt;= Pout, 0 otherwise</span>
    <span class="n">J_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_s&#39;</span><span class="p">)</span>
    <span class="n">P_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;P_s&#39;</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>

    <span class="n">sigmaRT</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">Temp</span> <span class="o">*</span> <span class="mf">1.0e3</span>  <span class="c1"># if C in mol/microL *1e9, and P in MPa *1e-6 =&gt; *1e3</span>

    <span class="k">if</span> <span class="n">dP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pbase</span> <span class="o">+</span> <span class="n">dP</span>
    <span class="n">Pi_e_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
    <span class="n">psi_ext</span> <span class="o">=</span> <span class="n">p_ext</span> <span class="o">-</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="n">Pi_e_peg</span>  <span class="c1"># subtract the osmotic pressure</span>

    <span class="c1"># Select the base of the root</span>
    <span class="n">v_base</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># it has to be = 1 here because based on firts index == 1</span>
    <span class="k">if</span> <span class="n">C_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_base</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v_base</span><span class="p">]</span> <span class="c1"># boundary condition at the root base</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># constant Matrix elements calculated only once, is data is None not a lot faster</span>
        <span class="c1"># only useful for calculation without Cpeg otherwise K changes</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">6</span>  <span class="c1"># -6 because of the coefficients outside the matrix at the boundaries</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

                <span class="c1"># dGp_i/dP_p</span>
                <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                    <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

            <span class="c1"># dGp_i/dP_i</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dC_i</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_j</span>
                <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># indexes of Matrix elements and right hand side elements depending on C and P</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="c1"># dGc_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1"># dGc_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">nid</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># 2 elements outside boundaries</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Matrix elements and right hand side elements depending on C and P</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C_base</span> <span class="c1"># C[v]  # dC/dx=0 =&gt; Cp=C[1] or C[1] = C_base</span>
            <span class="c1"># theta[v] = 1.0 # F. Bauget 2022-08-03</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="c1"># dGc_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

        <span class="c1"># dGc_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="c1"># dGc_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># -Gp</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_parent</span> <span class="o">+</span> <span class="n">diag</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">psi_ext</span><span class="p">)</span>
        <span class="c1"># -Gc</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span>
                         <span class="n">J_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                     <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>  <span class="c1"># += because it is -Gp</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_ext</span>  <span class="c1"># += because it is -Gp</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># ## to avoid singular matrix in A, especially when Js and/or Ps are zero and the Cini = 0.0</span>
    <span class="c1"># ## damping the inversion by adding a small value to the diagonal, this value is called Marquardt-Levenberg coefficient</span>
    <span class="c1"># for i in np.where((A.diagonal()) == 0)[0]:</span>
    <span class="c1">#     A[i,i] = 1.0e-10</span>

    <span class="n">solve</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">solve</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pbase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">J_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="c1"># J_s[v] = tau # F. Bauget 2022-09-27</span>
        <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>

<div class="viewcode-block" id="pressure_calculation_drag_permeating"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.pressure_calculation_drag_permeating">[docs]</a><span class="k">def</span> <span class="nf">pressure_calculation_drag_permeating</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mi">298</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">Ce</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Cse</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">Pe</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">Pbase</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">C_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;As :func:`~water_solute_transport.py.pressure_calculation` with a drag term in the solute transport equation.</span>

<span class="sd">    :param g: MTG</span>
<span class="sd">    :param Temp: float (Default value = 298)</span>
<span class="sd">    :param sigma: float (Default value = 1.0)</span>
<span class="sd">    :param Ce: float (Default value = 0.0)</span>
<span class="sd">    :param Cse: float (Default value = 0.0)</span>
<span class="sd">    :param dP: float (Default value = None)</span>
<span class="sd">    :param Pe: float (Default value = 0.4)</span>
<span class="sd">    :param Pbase: float (Default value = 0.1)</span>
<span class="sd">    :param data: numpy array (Default value = None)</span>
<span class="sd">    :param row: numpy array (Default value = None)</span>
<span class="sd">    :param col: numpy array (Default value = None)</span>
<span class="sd">    :param C_base: float (Default value = None)</span>
<span class="sd">    :returns: - g (MTG)</span>
<span class="sd">        - dx (array)</span>
<span class="sd">        - data (array)</span>
<span class="sd">        - row (array)</span>
<span class="sd">        - col (array)</span>

<span class="sd">    This function take into account the possibility to have non-permeating solute inside the root. This is, for instance,</span>
<span class="sd">    the case when performing cut and flow experiment in a solution containing such solute. Indeed, the non-permeating solute</span>
<span class="sd">    may enter the root at cut tips. It is referred to this non-permeating solute through Cpeg when C refers to the permeating solute</span>
<span class="sd">    penetrating radially the root.</span>
<span class="sd">    The presence of Cpeg may change the sap viscosity and has influence on the osmotic pressure see beginning of</span>
<span class="sd">    the function inside the root.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_out&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">p_in</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_in&#39;</span><span class="p">)</span>  <span class="c1"># it is pressure not potential</span>
    <span class="n">J_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_out&#39;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">Kexp</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K_exp&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>  <span class="c1"># en mol/microL</span>
    <span class="n">Cpeg</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;Cpeg&#39;</span><span class="p">)</span>  <span class="c1"># en mol/microL</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span>  <span class="c1"># 1 if Pin &gt;= Pout, 0 otherwise</span>
    <span class="n">J_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_s&#39;</span><span class="p">)</span>
    <span class="n">P_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;P_s&#39;</span><span class="p">)</span>  <span class="c1"># F. Bauget 2022-09-27</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">)</span>
    <span class="n">dKdCpeg</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">sigmaRT</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">Temp</span> <span class="o">*</span> <span class="mf">1.0e3</span>  <span class="c1"># if C in mol/microL *1e9, and P in MPa *1e-6 =&gt; *1e3</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g of water</span>
        <span class="n">dmu</span> <span class="o">=</span> <span class="n">derivative_viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g of water</span>
        <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Kexp</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dmu</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pbase</span> <span class="o">+</span> <span class="n">dP</span>
    <span class="n">Pi_e_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
    <span class="n">psi_ext</span> <span class="o">=</span> <span class="n">p_ext</span> <span class="o">-</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="n">Pi_e_peg</span>  <span class="c1"># subtract the osmotic pressure</span>
    <span class="n">derivative</span> <span class="o">=</span> <span class="n">derivative_osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>

    <span class="c1"># Select the base of the root</span>
    <span class="n">v_base</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># it has to be = 1 here because based on first index == 1</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">C_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_base</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v_base</span><span class="p">]</span>  <span class="c1"># boundary condition at the root base</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">12</span>  <span class="c1"># -12 because of the coefficients outside the matrix at the boundaries</span>
    <span class="c1">############</span>
    <span class="c1"># row and col indexes should be calculated once</span>
    <span class="c1">############</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dCpeg_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGp_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dC_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGc_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># dGCpeg_i/dCpeg_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">############</span>
    <span class="c1"># non-zero Jacobian terms</span>
    <span class="c1">############</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C_base</span>  <span class="c1"># C[v]  # dC/dx=0 =&gt; Cp=C[1] or C[1] = C_base</span>
            <span class="c1"># theta[v] = 1.0 # F. Bauget 2022-08-03</span>
            <span class="n">Cpeg_parent</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">Cpeg_parent</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

            <span class="c1"># dGp_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
        <span class="n">var_peg</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var_peg</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var_peg</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Ce</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

        <span class="c1"># dGp_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGCpeg_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_peg</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGp_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span>
            <span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>  <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="c1"># F. Bauget 2022-10-03 : error on derivative</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGp_i/dCpeg_i</span>
        <span class="n">derivative</span> <span class="o">=</span> <span class="n">derivative_osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># mol/microL -&gt; g/g</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">derivative</span> <span class="o">+</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGc_i/dCpeg_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># dGCpeg_i/dCpeg_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> \
                    <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span>  <span class="c1"># F. Bauget 2021-10-12</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="c1"># dGp_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dC_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGc_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGCpeg_i/dCpeg_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">-</span> \
                        <span class="n">dKdCpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2021-10-12</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># -Gp</span>
        <span class="n">Pi_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_parent</span> <span class="o">+</span> <span class="n">diag</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">psi_ext</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Pi_peg</span><span class="p">)</span>
        <span class="c1"># -Gc</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span>
                         <span class="n">J_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                                 <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="c1"># -GCpeg</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>  <span class="c1"># += because it is -Gp</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_ext</span>  <span class="c1"># += because it is -Gp</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Ce</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># ## to avoid singular matrix in A, especially when Js and/or Ps are zero and the Cini = 0.0</span>
    <span class="c1"># ## damping the inversion by adding a small value to the diagonal, this value is called Marquardt-Levenberg coefficient</span>
    <span class="c1"># for i in np.where((A.diagonal()) == 0)[0]:</span>
    <span class="c1">#     A[i,i] = 1.0e-10</span>

    <span class="n">solve</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">solve</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Ce</span><span class="p">:</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ce</span>
        <span class="k">if</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-20</span>
        <span class="k">if</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pbase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">Pi_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span>  <span class="c1"># from mol/microL to g/g</span>
        <span class="n">J_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pi_peg</span><span class="p">)</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="c1"># J_s[v] = tau # F. Bauget 2022-09-27</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>


<div class="viewcode-block" id="pressure_calculation_drag"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.pressure_calculation_drag">[docs]</a><span class="k">def</span> <span class="nf">pressure_calculation_drag</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mi">298</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">Ce</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">Cse</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dP</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">Pe</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">Pbase</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">C_base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; As :func:`~water_solute_transport.py.pressure_calculation` without non-permeating solutes and with a drag term</span>
<span class="sd">    in the solute transport equation.</span>

<span class="sd">    :param g: MTG</span>
<span class="sd">    :param Temp: float (Default value = 298)</span>
<span class="sd">    :param sigma: float (Default value = 1.0)</span>
<span class="sd">    :param Cse: float (Default value = 0.0)</span>
<span class="sd">    :param dP: float (Default value = None)</span>
<span class="sd">    :param Pe: float (Default value = 0.4)</span>
<span class="sd">    :param Pbase: float (Default value = 0.1)</span>
<span class="sd">    :param data: numpy array (Default value = None)</span>
<span class="sd">    :param row: numpy array (Default value = None)</span>
<span class="sd">    :param col: numpy array (Default value = None)</span>
<span class="sd">    :param C_base: float (Default value = None)</span>
<span class="sd">    :param Ce:  (Default value = 0.0)</span>
<span class="sd">    :returns: - g (MTG)</span>
<span class="sd">        - dx (array)</span>
<span class="sd">        - data (array)</span>
<span class="sd">        - row (array)</span>
<span class="sd">        - col (array)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># F. Bauget 2021-03-12 : added drag term -(1-sigma) * 0.5 * (C+Cse) * j</span>
    <span class="n">p_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_out&#39;</span><span class="p">)</span> <span class="c1"># it is pressure not potential</span>
    <span class="n">p_in</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;psi_in&#39;</span><span class="p">)</span> <span class="c1"># it is pressure not potential</span>
    <span class="n">J_out</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_out&#39;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="c1"># en mol/microL</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span> <span class="c1"># 1 if Pin &gt;= Pout, 0 otherwise</span>
    <span class="n">P_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;P_s&#39;</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>
    <span class="n">J_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_s&#39;</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>

    <span class="n">sigmaRT</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="n">Temp</span> <span class="o">*</span> <span class="mf">1.0e3</span> <span class="c1"># if C in mol/microL *1e9, and P in MPa *1e-6 =&gt; *1e3</span>
    <span class="k">if</span> <span class="n">dP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_ext</span> <span class="o">=</span> <span class="n">Pbase</span> <span class="o">+</span> <span class="n">dP</span>
    <span class="n">Pi_e_peg</span> <span class="o">=</span> <span class="n">osmotic_p_peg</span><span class="p">(</span><span class="n">Ce</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">8.0e6</span><span class="p">)</span> <span class="c1"># from mol/microL to g/g</span>
    <span class="n">psi_ext</span> <span class="o">=</span> <span class="n">p_ext</span> <span class="o">-</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="n">Pi_e_peg</span> <span class="c1"># subtract the osmotic pressure</span>

    <span class="c1"># Select the base of the root</span>
    <span class="n">v_base</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># it has to be = 1 here because based on firts index == 1</span>
    <span class="k">if</span> <span class="n">C_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">C_base</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v_base</span><span class="p">]</span> <span class="c1"># boundary condition at the root base</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#constant Matrix elements calculated only once</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">6</span> <span class="c1">#-6 because of the coefficients outside the matrix at the boundaries</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

                <span class="c1"># dGp_i/dP_p</span>
                <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">parent</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                    <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

            <span class="c1"># dGp_i/dP_i</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">diag</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># dGp_i/dC_i</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1"># dGp_i/dP_j</span>
                <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cid</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># indexes of Matrix elements and right hand side elements depending on C and P</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">v_base</span><span class="p">:</span>
                <span class="c1">#dGc_i/dP_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parent</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1">#dGc_i/dC_p</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#dGc_i/dP_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#dGc_i/dC_i</span>
            <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="c1">#dGc_i/dP_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cid</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1">#dGc_i/dC_j</span>
                <span class="n">row</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">col</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cid</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="n">nid</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span> <span class="c1">#2 elements outside boundaries</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Matrix elements and right hand side elements depending on C and P</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dS</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">Pbase</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C_base</span> <span class="c1"># C[v]  # dC/dx=0 =&gt; Cp=C[1] or C[1] = C_base</span>
            <span class="c1"># theta[v] = 1.0 # F. Bauget 2022-08-03</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_parent</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">C_parent</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="c1">#dGc_i/dP_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#dGc_i/dC_p</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">diag</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span>
        <span class="n">var2</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">diag</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">var</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">var2</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

        <span class="c1">#dGc_i/dP_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">dS</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">#dGc_i/dC_i</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span> <span class="n">var2</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">dS</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="c1"># F. Bauget 2022-10-03 : error on derivative</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="c1">#dGc_i/dP_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#dGc_i/dC_j</span>
            <span class="n">data</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">nid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">#-Gp</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_parent</span> <span class="o">+</span> <span class="n">diag</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">psi_ext</span><span class="p">)</span>
        <span class="c1">#-Gc</span>
        <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">C_parent</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_parent</span><span class="p">)</span> <span class="o">-</span>
                     <span class="n">J_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">dS</span> <span class="o">+</span> <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">dS</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>
                     <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">Cse</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="c1"># += because it is -Gp</span>
            <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[</span><span class="n">cid</span><span class="p">])</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="c1">#idem</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">:</span>
                <span class="n">theta_ext</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_ext</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_ext</span>  <span class="c1"># += because it is -Gp</span>
                <span class="n">b</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_ext</span> <span class="o">*</span> <span class="n">Cse</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">theta_ext</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>  <span class="c1"># idem</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">csc_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># ## to avoid singular matrix in A, especially when Js and/or Ps are zero and the Cini = 0.0</span>
    <span class="c1"># ## damping the inversion by adding a small value to the diagonal, this value is called Marquardt-Levenberg coefficient</span>
    <span class="c1"># for i in np.where((A.diagonal()) == 0)[0]:</span>
    <span class="c1">#     A[i,i] = 1.0e-10</span>

    <span class="n">solve</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">solve</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_base</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pbase</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices_iter</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">J_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_ext</span> <span class="o">-</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigmaRT</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_in</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>

<div class="viewcode-block" id="init_some_MTG_properties"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.init_some_MTG_properties">[docs]</a><span class="k">def</span> <span class="nf">init_some_MTG_properties</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">Cini</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">Cpeg_ini</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;initialization of some g properties specific to solute transport:</span>
<span class="sd">        - &#39;C&#39;: the permeating solute concentration,</span>
<span class="sd">        - &#39;Cpeg&#39;: the non-permeating solute concentration,</span>
<span class="sd">        - &#39;theta&#39;:  1 or 0 depending on the local flow direction in the xylem vessels 1 from tip to base, 0 the opposite</span>
<span class="sd">        - &#39;J_s&#39;: the pumping rate</span>

<span class="sd">    :param g: MTG</span>
<span class="sd">    :param tau: float (Default value = 0.)</span>
<span class="sd">    :param Cini: float (Default value = 0.)</span>
<span class="sd">    :param Cpeg_ini: float (Default value = 0.)</span>
<span class="sd">    :param t: int (Default value = 1)</span>
<span class="sd">    :returns: - g</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">Cpeg</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;Cpeg&#39;</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)</span> <span class="c1"># 1 if Pin &gt;= Pout, 0 otherwise</span>
    <span class="n">J_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;J_s&#39;</span><span class="p">)</span>
    <span class="n">P_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;P_s&#39;</span><span class="p">)</span> <span class="c1"># F. Bauget 2022-09-27</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

    <span class="c1"># Select the base of the root</span>
    <span class="n">v_base</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">component_roots_at_scale_iter</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">max_scale</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">traversal</span><span class="o">.</span><span class="n">post_order2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">v_base</span><span class="p">):</span>
        <span class="n">C</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cini</span> <span class="c1"># in mol/microL</span>
        <span class="n">Cpeg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cpeg_ini</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># F. Bauget 2022-09-27</span>
        <span class="n">J_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="c1"># if position[v] &gt;= 0.02:</span>
        <span class="c1">#     J_s[v] = tau / 4.0</span>
        <span class="c1"># else:</span>
        <span class="c1">#     J_s[v] = tau</span>

        <span class="n">P_s</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ps</span>
        <span class="c1"># if position[v] &gt;= 0.02:</span>
        <span class="c1">#     P_s[v] = Ps / 4.0</span>
        <span class="c1"># else:</span>
        <span class="c1">#     P_s[v] = Ps</span>
        <span class="c1"># Psmin = Ps/100.0</span>
        <span class="c1"># P_s[v] = (Ps - Psmin) / position[1] * position[v] + Psmin</span>

    <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="viscosity_peg"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.viscosity_peg">[docs]</a><span class="k">def</span> <span class="nf">viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dynamic viscosity, mu, calculation in mPa.s according to the PEG-8000 concentration for a temperature T = 298 K</span>
<span class="sd">    Fit done on a point at Cpeg=0, mu = 1 mPa.s and the 2 fist data points (Cpeg=0.1 and 0.2) of</span>
<span class="sd">    table 2 from Gonzllez-Tello J. Chem. Eng. Data 1994,39, 611-614</span>
<span class="sd">    </span>
<span class="sd">    mu = -17.4 + 18.4 exp(w/0.279)</span>
<span class="sd">    mu in mPa.s</span>
<span class="sd">    w in g/g water</span>

<span class="sd">    :param Cpeg: Float (Default value = 0.0)</span>
<span class="sd">    :param unit_factor: Float (Default value = 1.0)</span>
<span class="sd">    :returns: - mu: Float, the dynamic viscosity in mPa.s</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Cpeg</span> <span class="o">&lt;=</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Cpeg</span> <span class="o">*</span> <span class="n">unit_factor</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="mf">17.4</span> <span class="o">+</span> <span class="mf">18.4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mf">0.279</span><span class="p">)</span> <span class="c1"># 25 C</span>
    <span class="c1"># mu = -9.81 + 10.8 * math.exp(w/0.176) # 20 C</span>

    <span class="k">return</span> <span class="n">mu</span></div>

<div class="viewcode-block" id="derivative_viscosity_peg"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.derivative_viscosity_peg">[docs]</a><span class="k">def</span> <span class="nf">derivative_viscosity_peg</span><span class="p">(</span><span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dynamic viscosity derivative according to concentration, dmu</span>
<span class="sd">    see viscosity_peg</span>
<span class="sd">    </span>
<span class="sd">    dmu/dw = 18.4 exp(w/0.279)/0.279</span>
<span class="sd">    dmu in mPa.s</span>
<span class="sd">    w in g/g water</span>

<span class="sd">    :param Cpeg: Float (Default value = 0.0)</span>
<span class="sd">    :param unit_factor: Float (Default value = 1.0)</span>
<span class="sd">    :returns: - dmu: Float, the derivative</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Cpeg</span> <span class="o">&lt;=</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Cpeg</span> <span class="o">*</span> <span class="n">unit_factor</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="n">dmu</span> <span class="o">=</span> <span class="mf">18.4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mf">0.279</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.279</span> <span class="c1"># 25 C</span>
    <span class="c1"># dmu = 10.8 * math.exp(w/0.176)/0.176 # 20 C</span>

    <span class="k">return</span> <span class="n">dmu</span></div>

<div class="viewcode-block" id="osmotic_p_peg"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.osmotic_p_peg">[docs]</a><span class="k">def</span> <span class="nf">osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">25.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;osmotic pressure calculation of the PEG 8000</span>
<span class="sd">    equation 1 Michel, Plant Physiol. (1983) 72, 66-70</span>
<span class="sd">    </span>
<span class="sd">    pi = (1.29*w^2*T - 140*w^2 - 4.0*w)</span>
<span class="sd">    pi: bar</span>
<span class="sd">    w: g/g</span>
<span class="sd">    T: Celcius</span>

<span class="sd">    :param Cpeg: Float (Default value = 0.0)</span>
<span class="sd">    :param unit_factor: Float (Default value = 1.0)</span>
<span class="sd">    :param T: Float (Default value = 25.0)</span>
<span class="sd">    :returns: - osmotic_p: Float, the osmotic pressure (MPa)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Cpeg</span> <span class="o">&lt;</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">1.0e-20</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Cpeg</span> <span class="o">*</span> <span class="n">unit_factor</span>
    <span class="n">osmotic_p</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.29</span> <span class="o">*</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mi">140</span> <span class="o">*</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="c1"># bar -&gt; MPa</span>

    <span class="k">return</span> <span class="n">osmotic_p</span></div>

<div class="viewcode-block" id="derivative_osmotic_p_peg"><a class="viewcode-back" href="../../user/api_water_solute_transport.html#hydroroot.water_solute_transport.derivative_osmotic_p_peg">[docs]</a><span class="k">def</span> <span class="nf">derivative_osmotic_p_peg</span><span class="p">(</span><span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">unit_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">25.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;the 1st derivative according to X of the osmotic pressure calculation of the PEG 8000</span>
<span class="sd">    equation 1 Michel, Plant Physiol. (1983) 72, 66-70</span>
<span class="sd">    </span>
<span class="sd">    dpi/dw = (2 * 1.29*w*T - 2*140*w - 4.0)</span>
<span class="sd">    pi: bar</span>
<span class="sd">    w: g/g</span>
<span class="sd">    T: Celcius</span>

<span class="sd">    :param Cpeg: Float (Default value = 0.0)</span>
<span class="sd">    :param unit_factor: Float (Default value = 1.0)</span>
<span class="sd">    :param T: Float (Default value = 25.0)</span>
<span class="sd">    :returns: - osmotic_p: Float, the osmotic pressure (MPa)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Cpeg</span> <span class="o">&lt;</span> <span class="mf">1.0e-20</span><span class="p">:</span> <span class="n">Cpeg</span> <span class="o">=</span> <span class="mf">1.0e-20</span>
    <span class="c1"># dp/dCpeg = dw/dCpeg * dp/dw = unit_factor * dp/dw</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Cpeg</span> <span class="o">*</span> <span class="n">unit_factor</span> <span class="c1"># (g/g), if [Cpeg] = mol/microL then 1 g/g = 8e6 mol/microL</span>
    <span class="n">osmotic_p</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.58</span> <span class="o">*</span> <span class="n">w</span>  <span class="o">*</span> <span class="n">T</span> <span class="o">-</span> <span class="mi">280</span> <span class="o">*</span> <span class="n">w</span>  <span class="o">-</span> <span class="mf">4.0</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">unit_factor</span> <span class="c1"># bar/(g/g) -&gt; MPa/(Cpeg unit)</span>

    <span class="k">return</span> <span class="n">osmotic_p</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Yann Boursiac, Christophe Pradal, Fabrice Bauget, MikaÃ«l Lucas, Christophe Godin, Christophe Maurel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>